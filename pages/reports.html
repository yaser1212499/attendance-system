<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="../assets/img/favicon.png">
  <title>گزارشات - سیستم حضور و غیاب</title>
  <link href="https://fonts.googleapis.com/css?family=Vazirmatn:400,700&display=swap" rel="stylesheet" />
  <link href="../assets/css/argon-dashboard.css?v=2.1.0" rel="stylesheet" />
  <link href="../assets/css/argon-dashboard.custom-sidebar.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" />
  <style>
    body { font-family: 'Vazirmatn', sans-serif; }
    .card, .modal-content {
      border-radius: 1rem !important;
    }
    .card-header, .modal-header {
      border-radius: 1rem 1rem 0 0 !important;
      border-bottom: 1px solid #ececec;
      padding-top: 1rem;
      padding-bottom: 1rem;
    }
    .card-body, .modal-body {
      background: #fff;
      border-radius: 0 0 1rem 1rem !important;
      padding: 1.5rem;
    }
    .btn-primary, .btn-success, .btn-outline-primary, .btn-outline-secondary, .btn-secondary {
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .form-control, .form-select {
      border-radius: 0.5rem;
      font-size: 1rem;
      padding: 0.75rem 1rem;
    }
    .table {
      border-radius: 1rem;
      overflow: hidden;
      background: #fff;
    }
    .table th, .table td {
      vertical-align: middle;
      font-size: 0.98rem;
    }
    .nav-pills .nav-link { 
      border-radius: 0.5rem; 
      font-weight: 500; 
    }
    .nav-pills .nav-link.active { 
      background: #5e72e4 !important; 
      color: #fff; 
    }
    .tab-pane { 
      padding-top: 1.5rem; 
    }
    .icon-lg { 
      font-size: 2rem; 
      vertical-align: middle; 
    }
    .badge-status { 
      font-size: 0.95em; 
      padding: 0.5em 1em; 
      border-radius: 0.5rem; 
    }
    .progress { 
      height: 0.7rem; 
      border-radius: 0.5rem; 
    }
    .alert { 
      border-radius: 0.5rem; 
    }
    @media (max-width: 767px) {
      .tab-pane { 
        padding-top: 0.5rem; 
      }
    }
  </style>
</head>

<body class="g-sidenav-show rtl bg-gray-100">
  <div class="min-height-300 bg-dark position-absolute w-100"></div>
  <div id="sidebar-container"></div>
  
  <!-- Load sidebar manager -->
  <script src="../assets/js/sidebar-manager.js"></script>
  
  <main class="main-content position-relative border-radius-lg">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl " id="navbarBlur" data-scroll="false">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 ">
            <li class="breadcrumb-item text-sm ps-2"><a class="opacity-5 text-white" href="dashboard.html">صفحات</a></li>
            <li class="breadcrumb-item text-sm text-white active" aria-current="page">گزارشات</li>
          </ol>
          <h6 class="font-weight-bolder text-white mb-0">گزارشات جامع</h6>
        </nav>
      </div>
    </nav>
    <!-- End Navbar -->

    <div class="container-fluid py-4">
      <!-- تب‌های گزارشات -->
      <div class="card mb-4">
        <div class="card-header pb-0 d-flex align-items-center justify-content-between">
          <div><i class="fas fa-chart-bar me-2"></i>گزارشات جامع</div>
          <button class="btn btn-success btn-sm" onclick="exportReport()"><i class="fas fa-download me-2"></i>خروجی Excel</button>
        </div>
        <div class="card-body">
          <ul class="nav nav-pills nav-justified mb-4" id="reportTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab">
                <i class="fas fa-layer-group me-1"></i>نمای کلی
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="attendance-tab" data-bs-toggle="pill" data-bs-target="#attendance" type="button" role="tab">
                <i class="fas fa-user-check me-1"></i>حضور و غیاب
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="salary-tab" data-bs-toggle="pill" data-bs-target="#salary" type="button" role="tab">
                <i class="fas fa-money-bill-wave me-1"></i>حقوق
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="leave-tab" data-bs-toggle="pill" data-bs-target="#leave" type="button" role="tab">
                <i class="fas fa-calendar-alt me-1"></i>مرخصی
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="shift-tab" data-bs-toggle="pill" data-bs-target="#shift" type="button" role="tab">
                <i class="fas fa-clock me-1"></i>شیفت‌ها
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="performance-tab" data-bs-toggle="pill" data-bs-target="#performance" type="button" role="tab">
                <i class="fas fa-chart-line me-1"></i>عملکرد
              </button>
            </li>
          </ul>

          <div class="tab-content" id="reportTabContent">
            <!-- نمای کلی -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
              <div class="row g-4 mb-4">
                <div class="col-md-3">
                  <div class="card text-center p-3">
                    <i class="fas fa-users icon-lg text-primary mb-2"></i>
                    <h6 class="mb-1">کل کاربران</h6>
                    <h4 id="totalUsersOverview">-</h4>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card text-center p-3">
                    <i class="fas fa-user-check icon-lg text-success mb-2"></i>
                    <h6 class="mb-1">حضور امروز</h6>
                    <h4 id="todayAttendancesOverview">-</h4>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card text-center p-3">
                    <i class="fas fa-calendar-times icon-lg text-warning mb-2"></i>
                    <h6 class="mb-1">مرخصی در انتظار</h6>
                    <h4 id="pendingLeavesOverview">-</h4>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card text-center p-3">
                    <i class="fas fa-clock icon-lg text-info mb-2"></i>
                    <h6 class="mb-1">شیفت‌های فعال</h6>
                    <h4 id="activeShiftsOverview">-</h4>
                  </div>
                </div>
              </div>
              <div class="row g-4">
                <div class="col-lg-7 mb-4 mb-lg-0">
                  <div class="card">
                    <div class="card-header pb-0 pt-3 bg-transparent">
                      <h6 class="text-capitalize">نمودار حضور ماهانه</h6>
                    </div>
                    <div class="card-body p-3">
                      <div class="chart">
                        <canvas id="attendanceChart" class="chart-canvas" height="300"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-5">
                  <div class="card">
                    <div class="card-header pb-0 pt-3 bg-transparent">
                      <h6 class="text-capitalize">آمار تاخیر و غیبت امروز</h6>
                    </div>
                    <div class="card-body p-3" id="lateAbsenceStats"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- حضور و غیاب -->
            <div class="tab-pane fade" id="attendance" role="tabpanel">
              <div class="card mb-4">
                <div class="card-header pb-0 pt-3 bg-transparent">
                  <h6 class="text-capitalize">گزارش حضور روزانه</h6>
                </div>
                <div class="card-body p-3">
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <input type="date" class="form-control" id="attendanceDate" onchange="loadDailyAttendance()">
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table align-items-center mb-0" id="attendanceTable">
                      <thead>
                        <tr>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">نام</th>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">دپارتمان</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">اولین ورود</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">آخرین خروج</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">تعداد ورود</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">تعداد خروج</th>
                        </tr>
                      </thead>
                      <tbody id="attendanceTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-header pb-0 pt-3 bg-transparent">
                  <h6 class="text-capitalize">گزارش حضور ماهانه</h6>
                </div>
                <div class="card-body p-3">
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <input type="month" class="form-control" id="attendanceMonth" onchange="loadMonthlyAttendance()">
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table align-items-center mb-0">
                      <thead>
                        <tr>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">نام</th>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">دپارتمان</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">روزهای حضور</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">کل ورود</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">کل خروج</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">اولین حضور</th>
                        </tr>
                      </thead>
                      <tbody id="monthlyAttendanceTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
              <!-- گزارش حضور و غیاب ماهانه -->
              <div class="row mt-4">
                <div class="col-lg-12 mx-auto">
                  <div class="card">
                    <div class="card-header pb-0">
                      <h6>گزارش حضور و غیاب ماهانه</h6>
                      <form class="row g-2 align-items-center" id="report-filter-form">
                        <div class="col-auto">
                          <select class="form-select" id="user-select"></select>
                        </div>
                        <div class="col-auto">
                          <input type="number" class="form-control" id="year-input" min="1400" max="1500" placeholder="سال">
                        </div>
                        <div class="col-auto">
                          <input type="number" class="form-control" id="month-input" min="1" max="12" placeholder="ماه">
                        </div>
                        <div class="col-auto">
                          <button type="submit" class="btn btn-primary">نمایش</button>
                        </div>
                      </form>
                    </div>
                    <div class="card-body">
                      <div id="report-table-wrapper">
                        <div class="text-center text-secondary">در حال بارگذاری...</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- حقوق -->
            <div class="tab-pane fade" id="salary" role="tabpanel">
              <div class="card">
                <div class="card-header pb-0 pt-3 bg-transparent">
                  <h6 class="text-capitalize">گزارش حقوق و دستمزد</h6>
                </div>
                <div class="card-body p-3">
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <input type="month" class="form-control" id="salaryMonth" onchange="loadSalaryReport()">
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table align-items-center mb-0" id="salaryTable">
                      <thead>
                        <tr>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">نام</th>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">دپارتمان</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">حقوق پایه</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">اضافه‌کاری</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">پاداش</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">کسورات</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">حقوق نهایی</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">وضعیت</th>
                        </tr>
                      </thead>
                      <tbody id="salaryTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- مرخصی -->
            <div class="tab-pane fade" id="leave" role="tabpanel">
              <div class="card">
                <div class="card-header pb-0 pt-3 bg-transparent">
                  <h6 class="text-capitalize">گزارش مرخصی</h6>
                </div>
                <div class="card-body p-3">
                  <div class="row mb-3">
                    <div class="col-md-3">
                      <input type="date" class="form-control" id="leaveStartDate">
                    </div>
                    <div class="col-md-3">
                      <input type="date" class="form-control" id="leaveEndDate">
                    </div>
                    <div class="col-md-3">
                      <select class="form-select" id="leaveStatus">
                        <option value="">همه</option>
                        <option value="pending">در انتظار</option>
                        <option value="approved">تایید شده</option>
                        <option value="rejected">رد شده</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <button class="btn btn-primary w-100" onclick="loadLeaveReport()">بارگذاری</button>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table align-items-center mb-0" id="leaveTable">
                      <thead>
                        <tr>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">نام</th>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">نوع</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">از تاریخ</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">تا تاریخ</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">تعداد روز</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">وضعیت</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">دلیل</th>
                        </tr>
                      </thead>
                      <tbody id="leaveTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- شیفت‌ها -->
            <div class="tab-pane fade" id="shift" role="tabpanel">
              <div class="card">
                <div class="card-header pb-0 pt-3 bg-transparent">
                  <h6 class="text-capitalize">گزارش شیفت‌ها</h6>
                </div>
                <div class="card-body p-3">
                  <div class="table-responsive">
                    <table class="table align-items-center mb-0" id="shiftTable">
                      <thead>
                        <tr>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">نام شیفت</th>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">ساعت شروع</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">ساعت پایان</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">ساعت کاری</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">تعداد کارکنان</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">کارکنان</th>
                        </tr>
                      </thead>
                      <tbody id="shiftTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- عملکرد -->
            <div class="tab-pane fade" id="performance" role="tabpanel">
              <div class="card">
                <div class="card-header pb-0 pt-3 bg-transparent">
                  <h6 class="text-capitalize">گزارش عملکرد</h6>
                </div>
                <div class="card-body p-3">
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <input type="month" class="form-control" id="performanceMonth" onchange="loadPerformanceReport()">
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table align-items-center mb-0" id="performanceTable">
                      <thead>
                        <tr>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">نام</th>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">دپارتمان</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">روزهای حضور</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">ساعت اضافه‌کاری</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">ساعت کم‌کاری</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">تعداد مرخصی</th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">نرخ تایید مرخصی</th>
                        </tr>
                      </thead>
                      <tbody id="performanceTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Core JS Files -->
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/chartjs.min.js"></script>
  
  <script>
    // محافظت از صفحه: اگر توکن نبود، به صفحه ورود منتقل شود
    if (!localStorage.getItem('token')) {
      window.location.href = 'login.html';
    }

    let attendanceChart;

    document.addEventListener('DOMContentLoaded', function() {
      loadSystemOverview();
      loadAttendanceChart();
      loadLateAbsenceStats();
      loadShiftReport();
      
      // تنظیم تاریخ‌های پیش‌فرض
      document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('attendanceMonth').value = new Date().toISOString().slice(0, 7);
      document.getElementById('salaryMonth').value = new Date().toISOString().slice(0, 7);
      document.getElementById('performanceMonth').value = new Date().toISOString().slice(0, 7);
      document.getElementById('leaveStartDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('leaveEndDate').value = new Date().toISOString().split('T')[0];
      
      // بارگذاری گزارشات اولیه
      loadDailyAttendance();
      loadSalaryReport();
      loadPerformanceReport();
      
      // به‌روزرسانی خودکار آمار هر 5 دقیقه
      setInterval(loadSystemOverview, 300000);
    });

    // بارگذاری آمار کلی سیستم
    async function loadSystemOverview() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          console.log('No token found, displaying sample data');
          displaySampleData();
          return;
        }
        
        const response = await fetch('/api/reports/overview', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // به‌روزرسانی چهار کارت آماری
        document.getElementById('totalUsersOverview').textContent = data.total_users || 0;
        document.getElementById('todayAttendancesOverview').textContent = data.today_attendances || 0;
        document.getElementById('pendingLeavesOverview').textContent = data.pending_leaves || 0;
        document.getElementById('activeShiftsOverview').textContent = data.active_shifts || 0;
        
        console.log('Statistical cards updated with real data:', data);
      } catch (error) {
        console.error('Error loading system overview:', error);
        // نمایش داده‌های نمونه در صورت خطا
        displaySampleData();
      }
    }

    // نمایش داده‌های نمونه
    function displaySampleData() {
      document.getElementById('totalUsersOverview').textContent = '25';
      document.getElementById('todayAttendancesOverview').textContent = '18';
      document.getElementById('pendingLeavesOverview').textContent = '3';
      document.getElementById('activeShiftsOverview').textContent = '4';
      console.log('Displaying sample data for statistical cards');
    }

    // بارگذاری نمودار حضور
    async function loadAttendanceChart() {
      try {
        const token = localStorage.getItem('token');
        const currentDate = new Date();
        const response = await fetch(`/api/reports/attendance-chart?year=${currentDate.getFullYear()}&month=${currentDate.getMonth() + 1}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        if (attendanceChart) {
          attendanceChart.destroy();
        }
        
        attendanceChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: result.data.map(item => item.date),
            datasets: [{
              label: 'کاربران حاضر',
              data: result.data.map(item => item.present_users),
              borderColor: '#5e72e4',
              backgroundColor: 'rgba(94, 114, 228, 0.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'top',
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      } catch (error) {
        console.error('Error loading attendance chart:', error);
      }
    }

    // بارگذاری آمار تاخیر و غیبت
    async function loadLateAbsenceStats() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/reports/late-absence', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        
        document.getElementById('lateAbsenceStats').innerHTML = `
          <div class="alert alert-warning">
            <strong>غایب امروز:</strong> ${data.absent.length} نفر
          </div>
          <div class="alert alert-info">
            <strong>دیر آمده:</strong> ${data.late.length} نفر
          </div>
        `;
      } catch (error) {
        console.error('Error loading late absence stats:', error);
      }
    }

    // بارگذاری گزارش حضور روزانه
    async function loadDailyAttendance() {
      try {
        const token = localStorage.getItem('token');
        const date = document.getElementById('attendanceDate').value;
        const response = await fetch(`/api/reports/daily?date=${date}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        const tbody = document.getElementById('attendanceTableBody');
        tbody.innerHTML = '';
        
        result.data.forEach(item => {
          const row = `
            <tr>
              <td>
                <div class="d-flex px-2 py-1">
                  <div class="d-flex flex-column justify-content-center">
                    <h6 class="mb-0 text-sm">${item.name}</h6>
                  </div>
                </div>
              </td>
              <td>
                <p class="text-xs font-weight-bold mb-0">${item.department || 'نامشخص'}</p>
              </td>
              <td class="align-middle text-center text-sm">
                <span class="badge badge-sm bg-gradient-success">${item.first_in ? new Date(item.first_in).toLocaleTimeString('fa-IR') : '-'}</span>
              </td>
              <td class="align-middle text-center text-sm">
                <span class="badge badge-sm bg-gradient-info">${item.last_out ? new Date(item.last_out).toLocaleTimeString('fa-IR') : '-'}</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.entry_count}</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.exit_count}</span>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      } catch (error) {
        console.error('Error loading daily attendance:', error);
      }
    }

    // بارگذاری گزارش حضور ماهانه
    async function loadMonthlyAttendance() {
      try {
        const token = localStorage.getItem('token');
        const month = document.getElementById('attendanceMonth').value;
        const [year, monthNum] = month.split('-');
        const response = await fetch(`/api/reports/monthly?year=${year}&month=${monthNum}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        const tbody = document.getElementById('monthlyAttendanceTableBody');
        tbody.innerHTML = '';
        
        result.data.forEach(item => {
          const row = `
            <tr>
              <td>
                <div class="d-flex px-2 py-1">
                  <div class="d-flex flex-column justify-content-center">
                    <h6 class="mb-0 text-sm">${item.name}</h6>
                  </div>
                </div>
              </td>
              <td>
                <p class="text-xs font-weight-bold mb-0">${item.department || 'نامشخص'}</p>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.present_days} روز</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.total_entries}</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.total_exits}</span>
              </td>
              <td class="align-middle text-center text-sm">
                <span class="badge badge-sm bg-gradient-success">${item.first_attendance ? new Date(item.first_attendance).toLocaleDateString('fa-IR') : '-'}</span>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      } catch (error) {
        console.error('Error loading monthly attendance:', error);
      }
    }

    // بارگذاری گزارش حقوق
    async function loadSalaryReport() {
      try {
        const token = localStorage.getItem('token');
        const month = document.getElementById('salaryMonth').value;
        const [year, monthNum] = month.split('-');
        const response = await fetch(`/api/reports/salary?year=${year}&month=${monthNum}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        const tbody = document.getElementById('salaryTableBody');
        tbody.innerHTML = '';
        
        result.data.forEach(item => {
          const row = `
            <tr>
              <td>
                <div class="d-flex px-2 py-1">
                  <div class="d-flex flex-column justify-content-center">
                    <h6 class="mb-0 text-sm">${item.name}</h6>
                  </div>
                </div>
              </td>
              <td>
                <p class="text-xs font-weight-bold mb-0">${item.department || 'نامشخص'}</p>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.base_salary ? item.base_salary.toLocaleString() : '-'}</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.total_overtime_hours || 0} ساعت</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.bonus ? item.bonus.toLocaleString() : '-'}</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.deductions ? item.deductions.toLocaleString() : '-'}</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.total_salary ? item.total_salary.toLocaleString() : '-'}</span>
              </td>
              <td class="align-middle text-center text-sm">
                <span class="badge badge-sm bg-gradient-${item.status === 'paid' ? 'success' : 'warning'}">${item.status || 'نامشخص'}</span>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      } catch (error) {
        console.error('Error loading salary report:', error);
      }
    }

    // بارگذاری گزارش مرخصی
    async function loadLeaveReport() {
      try {
        const token = localStorage.getItem('token');
        const startDate = document.getElementById('leaveStartDate').value;
        const endDate = document.getElementById('leaveEndDate').value;
        const status = document.getElementById('leaveStatus').value;
        
        let url = `/api/reports/leave?start_date=${startDate}&end_date=${endDate}`;
        if (status) url += `&status=${status}`;
        
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        const tbody = document.getElementById('leaveTableBody');
        tbody.innerHTML = '';
        
        result.data.forEach(item => {
          const row = `
            <tr>
              <td>
                <div class="d-flex px-2 py-1">
                  <div class="d-flex flex-column justify-content-center">
                    <h6 class="mb-0 text-sm">${item.name}</h6>
                  </div>
                </div>
              </td>
              <td>
                <p class="text-xs font-weight-bold mb-0">${item.type}</p>
              </td>
              <td class="align-middle text-center text-sm">
                <span class="badge badge-sm bg-gradient-info">${new Date(item.start_date).toLocaleDateString('fa-IR')}</span>
              </td>
              <td class="align-middle text-center text-sm">
                <span class="badge badge-sm bg-gradient-info">${new Date(item.end_date).toLocaleDateString('fa-IR')}</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.days} روز</span>
              </td>
              <td class="align-middle text-center text-sm">
                <span class="badge badge-sm bg-gradient-${item.status === 'approved' ? 'success' : item.status === 'rejected' ? 'danger' : 'warning'}">${item.status}</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.reason || '-'}</span>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      } catch (error) {
        console.error('Error loading leave report:', error);
      }
    }

    // بارگذاری گزارش شیفت‌ها
    async function loadShiftReport() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/reports/shift', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        const tbody = document.getElementById('shiftTableBody');
        tbody.innerHTML = '';
        
        result.data.forEach(item => {
          const row = `
            <tr>
              <td>
                <div class="d-flex px-2 py-1">
                  <div class="d-flex flex-column justify-content-center">
                    <h6 class="mb-0 text-sm">${item.shift_name}</h6>
                  </div>
                </div>
              </td>
              <td class="align-middle text-center text-sm">
                <span class="badge badge-sm bg-gradient-success">${item.start_time}</span>
              </td>
              <td class="align-middle text-center text-sm">
                <span class="badge badge-sm bg-gradient-info">${item.end_time}</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.work_hours} ساعت</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.assigned_users}</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.user_names || '-'}</span>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      } catch (error) {
        console.error('Error loading shift report:', error);
      }
    }

    // بارگذاری گزارش عملکرد
    async function loadPerformanceReport() {
      try {
        const token = localStorage.getItem('token');
        const month = document.getElementById('performanceMonth').value;
        const [year, monthNum] = month.split('-');
        const response = await fetch(`/api/reports/performance?year=${year}&month=${monthNum}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        
        const tbody = document.getElementById('performanceTableBody');
        tbody.innerHTML = '';
        
        result.data.forEach(item => {
          const row = `
            <tr>
              <td>
                <div class="d-flex px-2 py-1">
                  <div class="d-flex flex-column justify-content-center">
                    <h6 class="mb-0 text-sm">${item.name}</h6>
                  </div>
                </div>
              </td>
              <td>
                <p class="text-xs font-weight-bold mb-0">${item.department || 'نامشخص'}</p>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.present_days} روز</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.overtime_hours || 0} ساعت</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.shortage_hours || 0} ساعت</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.leave_count || 0}</span>
              </td>
              <td class="align-middle text-center">
                <span class="text-secondary text-xs font-weight-bold">${item.leave_approval_rate || 0}%</span>
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      } catch (error) {
        console.error('Error loading performance report:', error);
      }
    }

    // خروجی Excel
    function exportReport() {
      alert('این قابلیت در حال توسعه است...');
    }

    // بارگذاری لیست کاربران برای فیلتر
    fetch('/api/users')
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById('user-select');
        select.innerHTML = '<option value="">همه کاربران</option>' +
          data.data.map(u => `<option value="${u.userId}">${u.name}</option>`).join('');
      });

    function loadReport(user_id, year, month) {
      const params = [];
      if (user_id) params.push('user_id=' + user_id);
      if (year) params.push('year=' + year);
      if (month) params.push('month=' + month);
      const url = '/api/report/getMonthlyAttendance' + (params.length ? '?' + params.join('&') : '');
      fetch(url)
        .then(res => res.json())
        .then(data => {
          const wrapper = document.getElementById('report-table-wrapper');
          if (!data.data || data.data.length === 0) {
            wrapper.innerHTML = '<div class="text-danger">داده‌ای یافت نشد.</div>';
            return;
          }
          // فقط یک کارمند یا همه؟
          const reports = data.data.length && data.data[0].daily ? data.data : [{ name: '', daily: data.data }];
          wrapper.innerHTML = reports.map(r => `
            <h6 class="mt-3">${r.name ? 'کارمند: ' + r.name : ''}</h6>
            <div class="table-responsive">
              <table class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>تاریخ</th><th>ورود</th><th>خروج</th><th>ساعت کار</th><th>تأخیر</th><th>کم‌کاری</th><th>اضافه‌کاری</th><th>مرخصی</th><th>غیبت</th><th>ناقص</th><th>تعطیل</th><th>وضعیت</th>
                  </tr>
                </thead>
                <tbody>
                  ${r.daily.map(d => `
                    <tr>
                      <td>${d.date}</td>
                      <td>${d.in || '-'}</td>
                      <td>${d.out || '-'}</td>
                      <td>${d.work_hours || '-'}</td>
                      <td>${d.delay || '-'}</td>
                      <td>${d.undertime || '-'}</td>
                      <td>${d.overtime || '-'}</td>
                      <td>${d.leave ? '✔' : '-'}</td>
                      <td>${d.absent ? '✔' : '-'}</td>
                      <td>${d.incomplete ? '✔' : '-'}</td>
                      <td>${d.holiday ? '✔' : '-'}</td>
                      <td>${d.status}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `).join('');
        });
    }

    document.getElementById('report-filter-form').onsubmit = function(e) {
      e.preventDefault();
      const user_id = document.getElementById('user-select').value;
      const year = document.getElementById('year-input').value;
      const month = document.getElementById('month-input').value;
      loadReport(user_id, year, month);
    };
    // بارگذاری اولیه
    setTimeout(() => loadReport('', '', ''), 500);
  </script>
</body>
</html> 